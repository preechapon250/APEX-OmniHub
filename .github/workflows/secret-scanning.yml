# SECRET SCANNING WORKFLOW
# Prevents secrets from being committed to the repository
# Uses TruffleHog to scan for exposed credentials

name: Secret Scanning

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  scan-secrets:
    name: Scan for Exposed Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive scan

      - name: Determine TruffleHog scan range
        id: trufflehog-range
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_REF="${{ github.event.pull_request.base.sha }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
          else
            BASE_REF="${{ github.event.before }}"
            HEAD_REF="${{ github.sha }}"
          fi

          if [[ -z "${BASE_REF}" || "${BASE_REF}" == "0000000000000000000000000000000000000000" || "${BASE_REF}" == "${HEAD_REF}" ]]; then
            echo "use_range=false" >> "${GITHUB_OUTPUT}"
            echo "Using full repository secret scan (no valid commit range available)."
          else
            echo "use_range=true" >> "${GITHUB_OUTPUT}"
            echo "base_ref=${BASE_REF}" >> "${GITHUB_OUTPUT}"
            echo "head_ref=${HEAD_REF}" >> "${GITHUB_OUTPUT}"
            echo "Using incremental secret scan from ${BASE_REF} to ${HEAD_REF}."
          fi

      - name: Run TruffleHog scan (commit range)
        if: steps.trufflehog-range.outputs.use_range == 'true'
        uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004
        with:
          path: ./
          base: ${{ steps.trufflehog-range.outputs.base_ref }}
          head: ${{ steps.trufflehog-range.outputs.head_ref }}
          extra_args: --only-verified --exclude-paths .trufflehog-exclude-paths.txt

      - name: Run TruffleHog scan (full repository fallback)
        if: steps.trufflehog-range.outputs.use_range == 'false'
        uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004
        with:
          path: ./
          extra_args: --only-verified --exclude-paths .trufflehog-exclude-paths.txt

      - name: Scan with Gitleaks (backup scanner)
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true  # Don't fail CI - report only
        with:
          config-path: .gitleaks.toml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }} # Optional: for Gitleaks Pro

  verify-no-env-files:
    name: Verify No .env Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for .env files
        run: |
          echo "Searching for .env files..."

          # Find all .env files (excluding .env.example)
          ENV_FILES=$(find . -type f -name ".env" ! -name ".env.example" ! -path "*/node_modules/*" ! -path "*/.git/*")

          if [ -n "$ENV_FILES" ]; then
            echo "âŒ ERROR: Found .env files in repository:"
            echo "$ENV_FILES"
            echo ""
            echo "Please remove these files and add them to .gitignore"
            exit 1
          else
            echo "âœ… No .env files found (excluding .env.example)"
          fi

      - name: Verify .env in .gitignore
        run: |
          echo "Checking .gitignore..."

          if ! grep -q "^\.env$" .gitignore; then
            echo "âŒ ERROR: .env is not in .gitignore"
            echo "Please add '.env' to .gitignore"
            exit 1
          else
            echo "âœ… .env is properly ignored"
          fi

  scan-dependencies:
    name: Scan Dependencies for Vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Snyk Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true # Don't fail build, just report

      - name: Run npm audit
        run: |
          npm audit --audit-level=high --json > security/npm-audit-latest.json || true

          # Check for critical vulnerabilities
          CRITICAL=$(cat security/npm-audit-latest.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat security/npm-audit-latest.json | jq '.metadata.vulnerabilities.high // 0')

          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "âŒ ERROR: Found $CRITICAL critical vulnerabilities"
            echo "Please run 'npm audit fix' to resolve"
            exit 1
          fi

          if [ "$HIGH" -gt 5 ]; then
            echo "âš ï¸ WARNING: Found $HIGH high vulnerabilities (threshold: 5)"
          fi

  verify-secrets-manager:
    name: Verify Secrets Manager Usage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential hardcoded secrets..."

          # Check for common secret patterns
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "AKIA[0-9A-Z]{16}" # AWS access key
            "sk-[a-zA-Z0-9]{32,}" # OpenAI API key
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" src/ --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules; then
              echo "âš ï¸ WARNING: Found potential hardcoded secret matching pattern: $pattern"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "WARNING: Never store secrets in VITE_* (client-exposed). Use server-only env vars or a secret manager (e.g. Doppler)."
          else
            echo "âœ… No hardcoded secrets detected"
          fi

  report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [scan-secrets, verify-no-env-files, scan-dependencies]
    if: always()

    steps:
      - name: Generate Security Report
        run: |
          echo "## ðŸ”’ Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check job results
          if [ "${{ needs.scan-secrets.result }}" == "success" ]; then
            echo "âœ… **Secret Scanning:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Secret Scanning:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.verify-no-env-files.result }}" == "success" ]; then
            echo "âœ… **.env File Check:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **.env File Check:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.scan-dependencies.result }}" == "success" ]; then
            echo "âœ… **Dependency Scan:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Dependency Scan:** WARNINGS" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- Review any warnings or failures above" >> $GITHUB_STEP_SUMMARY
          echo "- Run \`npm audit fix\` for dependency vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "- Remove any .env files and add to .gitignore" >> $GITHUB_STEP_SUMMARY
          echo "- Use Doppler for secrets management" >> $GITHUB_STEP_SUMMARY
