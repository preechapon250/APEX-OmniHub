name: Nightly Agent Evaluation

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  evaluate-agent:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run agent evaluations
      run: |
        # Set up Supabase environment
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
        echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV

        # Run evaluation on all active eval cases
        curl -X POST "${{ secrets.SUPABASE_URL }}/functions/v1/omnilink-eval" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
          -d '{"run_all_active": true}' \
          -o evaluation_results.json

    - name: Generate evaluation report
      run: |
        echo "# Nightly Agent Evaluation Report" > evaluation_report.md
        echo "" >> evaluation_report.md
        echo "**Date:** $(date)" >> evaluation_report.md
        echo "**Run:** ${{ github.run_id }}" >> evaluation_report.md
        echo "" >> evaluation_report.md

        if [ -f evaluation_results.json ]; then
          echo "## Results Summary" >> evaluation_report.md
          jq -r '.evaluations[] | "- **\(.eval_case_id)**: \(.verdict) (\(.score))"' evaluation_results.json >> evaluation_report.md
          echo "" >> evaluation_report.md
          echo "## Detailed Results" >> evaluation_report.md
          jq -r '.evaluations[] | "### \(.eval_case_id)\n- Score: \(.score)\n- Verdict: \(.verdict)\n- Skills Found: \(.skills_found | join(", "))\n- Response Quality: \(.response_quality)\n- Performance: \(.performance_ms)ms\n"' evaluation_results.json >> evaluation_report.md
        else
          echo "## Error: No evaluation results found" >> evaluation_report.md
        fi

    - name: Upload evaluation results
      uses: actions/upload-artifact@v4
      with:
        name: evaluation-results-${{ github.run_id }}
        path: |
          evaluation_results.json
          evaluation_report.md

    - name: Send notification on failures
      if: failure()
      run: |
        echo "Nightly evaluation failed. Check the artifacts for details."
        # In a real scenario, you might send a Slack notification or email here

  health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Health check
      run: |
        echo "Performing basic health checks..."
        # Check if required files exist
        if [ ! -f "supabase/functions/omnilink-agent/index.ts" ]; then
          echo "ERROR: omnilink-agent function missing"
          exit 1
        fi

        if [ ! -f "supabase/functions/omnilink-eval/index.ts" ]; then
          echo "ERROR: omnilink-eval function missing"
          exit 1
        fi

        if [ ! -f "supabase/migrations/20251221000001_omnilink_ops_pack.sql" ]; then
          echo "ERROR: Ops pack migration missing"
          exit 1
        fi

        echo "âœ… All required files present"